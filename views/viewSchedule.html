<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Exam Schedule</title>
<link rel="stylesheet" href="viewSchedule.css">
</head>
<body>

<div class="container">
<header class="header fade-in">
    <div class="header-left">
        <a href="#" class="back-button" onclick="goBack()">
            ‚Üê
        </a>
        <h1>My Exam Schedule</h1>
    </div>
    <div class="user-info">
        <span id="userName">Loading...</span>
        <div class="user-avatar" id="userAvatar">--</div>
    </div>
</header>

<!-- Schedule Container -->
<div class="schedule-container fade-in">
    <div class="schedule-header">
        <h2>Allocated Exams</h2>
        <span class="schedule-count" id="scheduleCount">Loading...</span>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
        <button class="filter-btn active" onclick="filterSchedule('all')">All Exams</button>
        <button class="filter-btn" onclick="filterSchedule('morning')">Morning</button>
        <button class="filter-btn" onclick="filterSchedule('afternoon')">Afternoon</button>
        <button class="filter-btn" onclick="filterSchedule('attended')">Attended</button>
        <button class="filter-btn" onclick="filterSchedule('pending')">Pending</button>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
        <div class="spinner"></div>
        <p>Loading your exam schedule...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-state" style="display: none;">
        <p>Failed to load schedules. Please try again.</p>
        <button onclick="loadSchedules()" class="retry-btn">Retry</button>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <p>No exams allocated yet.</p>
    </div>

    <!-- Schedule Grid -->
    <div class="schedule-grid" id="scheduleGrid" style="display: none;">
        <!-- Schedules will be populated here -->
    </div>
</div>

<!-- Actions Bar -->
<div class="actions-bar fade-in">
    <a href="#" class="action-btn btn-secondary" onclick="goToHome()">
        üè† Back to Home
    </a>
</div>
</div>

<!-- Logout -->
<div class="modal-overlay" id="logoutModal">
    <div class="modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to logout?</p>
        <div class="modal-buttons">
            <button class="modal-btn btn-cancel" onclick="hideLogout()">Cancel</button>
            <button class="modal-btn btn-confirm" onclick="confirmLogout()">Logout</button>
        </div>
    </div>
</div>

<script>
let allSchedules = [];
let currentFilter = 'all';

// Load schedules on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSchedules();
    loadUserInfo();
});

// Fetch schedules from backend
async function loadSchedules() {
  const loadingState = document.getElementById('loadingState');
  const errorState = document.getElementById('errorState');
  const emptyState = document.getElementById('emptyState');
  const scheduleGrid = document.getElementById('scheduleGrid');

  try {
    loadingState.style.display = 'block';
    errorState.style.display = 'none';
    emptyState.style.display = 'none';
    scheduleGrid.style.display = 'none';

    // Get teacherId from localStorage as fallback

    const response = await fetch(`http://localhost:5000/teacher/getSchedule`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', 

    });

    console.log('Response status:', response.status);

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Error response:', errorData);
      throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    console.log('Success result:', result);
    
    loadingState.style.display = 'none';

    if (result.success && result.data.length > 0) {
      allSchedules = result.data;
      renderSchedules(allSchedules);
      updateScheduleCount(allSchedules.length);
      scheduleGrid.style.display = 'grid';
      loadUserInfo(result.name)
    } else {
      emptyState.style.display = 'block';
      updateScheduleCount(0);
    }

  } catch (error) {
    console.error('Error loading schedules:', error);
    loadingState.style.display = 'none';
    errorState.style.display = 'block';
    
    // Show specific error message
    const errorMsg = document.querySelector('#errorState p');
    if (errorMsg) {
      errorMsg.textContent = error.message || 'Failed to load schedules. Please try again.';
    }
  }
}

// Render schedules
function renderSchedules(schedules) {
    const scheduleGrid = document.getElementById('scheduleGrid');
    scheduleGrid.innerHTML = '';

    schedules.forEach((schedule, index) => {
        const scheduleItem = document.createElement('div');
        scheduleItem.className = `schedule-item stagger-in ${schedule.status}`;
        scheduleItem.setAttribute('data-status', schedule.status);
        scheduleItem.style.animationDelay = `${index * 0.1}s`;

        scheduleItem.innerHTML = `
            ${schedule.status === 'attended' ? '<div class="attended-badge">‚úì Attended</div>' : ''}
            <div class="date-info">
                <div class="date-day">${schedule.dateDay}</div>
                <div class="date-month">${schedule.dateMonth}</div>
            </div>
            <div class="session-badge session-${schedule.session.toLowerCase()}">${schedule.session}</div>
            <div class="classroom-info">
                <div class="classroom-number">${schedule.classroom.number}</div>
                <div class="classroom-building">${schedule.classroom.building}</div>
            </div>
            <div class="schedule-arrow">‚Üí</div>
        `;

        if (schedule.status === 'pending') {
            scheduleItem.style.cursor = 'pointer';
            scheduleItem.onclick = () => viewExamDetails(schedule.id);
        }

        scheduleGrid.appendChild(scheduleItem);
    });
}

// Filter
function filterSchedule(type) {
    const buttons = document.querySelectorAll('.filter-btn');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    currentFilter = type;

    let filteredSchedules = allSchedules;
    
    switch(type) {
        case 'morning':
            filteredSchedules = allSchedules.filter(s => s.session === 'Morning');
            break;
        case 'afternoon':
            filteredSchedules = allSchedules.filter(s => s.session === 'Afternoon');
            break;
        case 'attended':
            filteredSchedules = allSchedules.filter(s => s.status === 'attended');
            break;
        case 'pending':
            filteredSchedules = allSchedules.filter(s => s.status === 'pending');
            break;
        default:
            filteredSchedules = allSchedules;
    }

    renderSchedules(filteredSchedules);
    updateScheduleCount(filteredSchedules.length);
}

function updateScheduleCount(count) {
    document.getElementById('scheduleCount').textContent = `${count} Exam${count !== 1 ? 's' : ''}`;
}

function loadUserInfo(name) {
    const userInitials = name.split(' ').map(n => n[0]).join('').toUpperCase();
    
    document.getElementById('userName').textContent = name;  // Use 'name' not 'userName'
    document.getElementById('userAvatar').textContent = userInitials;
}

function goToHome() {
    window.location.href = '/home.html';
}

function goBack() {
    window.history.back();
}

// Click avatar to show logout confirmation
document.getElementById('userAvatar').addEventListener('click', function() {
    document.getElementById('logoutModal').classList.add('show');
});

function hideLogout() {
    document.getElementById('logoutModal').classList.remove('show');
}

function confirmLogout() {
  fetch('/login/logout', { credentials: 'include' });
  window.location.href = 'http://localhost:3000';
}
function viewExamDetails(scheduleId) {
    // Redirect to exam allocation page with scheduleId in query params
    console.log(scheduleId);
    window.location.href = `http://localhost:5000/examAllocations.html?scheduleId=${scheduleId}`;
}



</script>
</body>
</html>