<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Allocations</title>
<link rel="stylesheet" href="viewSchedule.css" />
</head>
<body>
<div class="container">
  <!-- Header -->
  <header class="header fade-in">
    <div class="header-left">
      <a href="#" class="back-button" onclick="goBack()">‚Üê</a>
      <h1>Exam Allocations</h1>
    </div>
    <div class="user-info">
      <span id="userName"></span>
      <div class="user-avatar" id="userAvatar"></div>
    </div>
  </header>

  <!-- Schedule Container -->
  <div class="schedule-container fade-in">
    <div class="schedule-header">
      <h2>Teacher Allocations</h2>
      <span class="schedule-count" id="allocationCount">Loading...</span>
    </div>

    <!-- Filter Buttons -->
    <div class="filter-buttons">
      <button class="filter-btn active" onclick="filterAllocations('all')">All Teachers</button>
      <button class="filter-btn" onclick="filterAllocations('morning')">Morning</button>
      <button class="filter-btn" onclick="filterAllocations('afternoon')">Afternoon</button>
      <input type="date" id="dateFilter" style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-color);" />
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="empty-state">
      <p>Loading allocations...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <p>No allocations found for this date.</p>
    </div>

    <!-- Schedule Grid -->
    <div class="schedule-grid" id="scheduleGrid" style="display: none;">
      <!-- Allocations will be populated here -->
    </div>
  </div>

  <!-- Actions -->
  <div class="actions-bar fade-in">
    <a href="/home.html" class="action-btn btn-secondary">üè† Back to Home</a>
  </div>
</div>

<!-- Swap Modal -->
<div class="modal-overlay" id="swapModal">
  <div class="modal">
    <h3 id="modalTeacherName">Request Swap</h3>
    <textarea id="swapMessage" placeholder="Optional message..." style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px;"></textarea>
    <div class="modal-buttons">
      <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn btn-confirm" onclick="sendSwapRequest()">Send Request</button>
    </div>
  </div>
</div>

<script>
let selectedAllocation = null;
let selectedTeacher = null;
let allAllocations = [];
let currentTeacherId = null;
let currentFilter = 'all';

function getScheduleIdFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get('scheduleId');
}

async function loadAllocations() {
  const scheduleId = getScheduleIdFromURL();
  const loadingState = document.getElementById('loadingState');
  const emptyState = document.getElementById('emptyState');
  const scheduleGrid = document.getElementById('scheduleGrid');

  if (!scheduleId) {
    loadingState.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  try {
    const response = await fetch('http://localhost:5000/teacher/getAllocationDetails', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ scheduleId })
    });

    const result = await response.json();

    if (result.success && result.data.length > 0) {
      loadUserInfo(result.name);
      
      allAllocations = result.data.map(item => {
        const dateObj = new Date(item.date);
        return {
          ...item,
          dateDay: dateObj.getDate(),
          dateMonth: dateObj.toLocaleString('en-US', { month: 'short' }),
          dateYear: dateObj.getFullYear(),
        };
      });

      const myAllocation = allAllocations.find(a => a.id === scheduleId);
      if (myAllocation) {
        currentTeacherId = myAllocation.teacherId._id || myAllocation.teacherId.id || myAllocation.teacherId;
      }

      loadingState.style.display = 'none';
      scheduleGrid.style.display = 'grid';
      renderAllocations(allAllocations);
      updateAllocationCount(allAllocations.length);
    } else {
      loadingState.style.display = 'none';
      emptyState.style.display = 'block';
    }
  } catch (err) {
    console.error(err);
    loadingState.style.display = 'none';
    emptyState.style.display = 'block';
  }
}

function isClickedAllocation(allocation) {
  const scheduleId = getScheduleIdFromURL();
  return allocation.id === scheduleId;
}

function isMyOtherDuty(allocation) {
  const allocTeacherId = allocation.teacherId._id || allocation.teacherId.id || allocation.teacherId;
  return currentTeacherId && allocTeacherId === currentTeacherId && !isClickedAllocation(allocation);
}

function renderAllocations(allocations) {
  const scheduleGrid = document.getElementById('scheduleGrid');
  scheduleGrid.innerHTML = '';

  // Separate clicked allocation and others (excluding our other duties)
  const myClickedAllocation = allocations.filter(a => isClickedAllocation(a));
  const otherAllocations = allocations.filter(a => !isClickedAllocation(a) && !isMyOtherDuty(a));

  let index = 0;

  // Render clicked allocation first with blue background
  myClickedAllocation.forEach((allocation) => {
    const scheduleItem = document.createElement('div');
    scheduleItem.className = 'schedule-item stagger-in';
    scheduleItem.style.animationDelay = `${index * 0.1}s`;
    scheduleItem.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    scheduleItem.style.color = 'white';
    scheduleItem.style.border = '2px solid #5a67d8';

    scheduleItem.innerHTML = `
      
      <div class="date-info" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
        <div class="date-day" style="color: white;">${allocation.dateDay}</div>
        <div class="date-month" style="color: white;">${allocation.dateMonth}</div>
      </div>
      <div class="exam-details">
        <div class="exam-subject" style="color: white;">${allocation.teacher}</div>
        <div class="exam-code" style="color: rgba(255,255,255,0.9);">Room: ${allocation.classroom.number} ‚Ä¢ ${allocation.classroom.building}</div>
      </div>
      <div class="session-badge session-${allocation.session.toLowerCase()}">${allocation.session}</div>
      <div class="schedule-arrow" style="color: white;">‚Üí</div>
    `;

    scheduleItem.style.cursor = 'default';
    scheduleGrid.appendChild(scheduleItem);
    index++;
  });

  // Add separator if both sections exist
  if (myClickedAllocation.length > 0 && otherAllocations.length > 0) {
    const separator = document.createElement('div');
    separator.style.gridColumn = '1 / -1';
    separator.style.margin = '1rem 0';
    separator.style.padding = '0.5rem 0';
    separator.style.borderBottom = '2px solid var(--border-color)';
    separator.innerHTML = '<h3 style="font-size: 1.1rem; color: var(--text-secondary);">Other Teachers</h3>';
    scheduleGrid.appendChild(separator);
  }

  // Render other allocations
  otherAllocations.forEach((allocation) => {
    const scheduleItem = document.createElement('div');
    scheduleItem.className = 'schedule-item stagger-in';
    scheduleItem.style.animationDelay = `${index * 0.1}s`;

    scheduleItem.innerHTML = `
      <div class="date-info">
        <div class="date-day">${allocation.dateDay}</div>
        <div class="date-month">${allocation.dateMonth}</div>
      </div>
      <div class="exam-details">
        <div class="exam-subject">${allocation.teacher}</div>
        <div class="exam-code">Room: ${allocation.classroom.number} ‚Ä¢ ${allocation.classroom.building}</div>
      </div>
      <div class="session-badge session-${allocation.session.toLowerCase()}">${allocation.session}</div>
      <div class="schedule-arrow">‚Üí</div>
    `;

    scheduleItem.style.cursor = 'pointer';
    scheduleItem.onclick = () => openModal(allocation);
    scheduleGrid.appendChild(scheduleItem);
    index++;
  });
}

function filterAllocations(type) {
  const buttons = document.querySelectorAll('.filter-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  currentFilter = type;
  let filteredAllocations = allAllocations;
  
  switch(type) {
    case 'morning':
      filteredAllocations = allAllocations.filter(a => a.session === 'Morning');
      break;
    case 'afternoon':
      filteredAllocations = allAllocations.filter(a => a.session === 'Afternoon');
      break;
    default:
      filteredAllocations = allAllocations;
  }

  renderAllocations(filteredAllocations);
  updateAllocationCount(filteredAllocations.length);
}

function updateAllocationCount(count) {
  document.getElementById('allocationCount').textContent = `${count} Teacher${count !== 1 ? 's' : ''}`;
}

function openModal(allocation) {
  selectedAllocation = allocation;
  selectedTeacher = allocation.teacher;
  document.getElementById("modalTeacherName").textContent = `Request swap with ${allocation.teacher}`;
  document.getElementById("swapMessage").value = "";
  document.getElementById("swapModal").classList.add("show");
}

function closeModal() {
  document.getElementById("swapModal").classList.remove("show");
}

async function sendSwapRequest() {
  const message = document.getElementById("swapMessage").value;
  const fromAllocationId = getScheduleIdFromURL(); // This is YOUR allocation
  const toAllocationId = selectedAllocation.id; // This is THEIR allocation
  const toTeacherId = selectedAllocation.teacherId._id || selectedAllocation.teacherId;
  const examId = selectedAllocation.exam.id._id || selectedAllocation.exam.id;

  if (!examId) {
    alert('Error: Exam ID not found in allocation data');
    return;
  }

  try {
    const response = await fetch('http://localhost:5000/requests/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ 
        fromAllocationId,  // YOUR allocation
        toAllocationId,    // THEIR allocation
        toTeacherId: toTeacherId, 
        message: message, 
        examId: examId 
      })
    });

    const result = await response.json();
    if (result.success) {
      alert(`Swap request sent to ${selectedTeacher}`);
    } else {
      alert(`Failed to send swap request: ${result.message}`);
    }
  } catch (err) {
    console.error(err);
    alert('Error sending swap request');
  } finally {
    closeModal();
  }
}

function goBack() {
  window.history.back();
}

function loadUserInfo(userName) {
  const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();
  document.getElementById('userName').textContent = userName;
  document.getElementById('userAvatar').textContent = userInitials;
}

document.getElementById('userAvatar').addEventListener('click', function confirmLogout() {
  fetch('/login/logout', { credentials: 'include' });
  window.location.href = 'http://localhost:3000';
});

document.getElementById("dateFilter").addEventListener("change", (e) => {
  const selectedDate = e.target.value;
  if (selectedDate) {
    const filtered = allAllocations.filter(item => item.date.split('T')[0] === selectedDate);
    renderAllocations(filtered);
    updateAllocationCount(filtered.length);
  } else {
    filterAllocations(currentFilter);
  }
});

document.addEventListener('DOMContentLoaded', () => {
  loadAllocations();
});
</script>
</body>
</html>