<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Exam</title>
    <link rel="stylesheet" href="createExam.css">
</head>
<body>
    <div class="topbar">
        <div style="padding-left: 75px; padding-top: 8px;padding-bottom: 8px;"><img class="logo" src="/public/college-logo.png" alt="college-logo"></div>
        <div class="topbar-buttons">
            <button class="topbar-btn" id='home'>Home</button>
            <button class="topbar-btn">Notification</button>
            <button class="topbar-btn">Logout</button>
        </div>
    </div>

    <div class="form-container">
        <h2 class="form-title">Create New Exam</h2>
        
        <form id="examForm">
            <div class="form-group">
                <label for="examName">Exam Name</label>
                <input type="text" id="examName" name="examName" required>
            </div>

            <div class="form-group">
                <label for="duration">Duration (in minutes)</label>
                <input type="number" id="duration" name="duration" min="1" required>
            </div>

            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="startDate">Start Date</label>
                    <input type="datetime-local" id="startDate" name="startDate" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="endDate">End Date</label>
                    <input type="datetime-local" id="endDate" name="endDate" required>
                </div>
            </div>

            <div class="form-group">
                <label>Classroom Selection</label>
                <button type="button" class="popup-btn" id="classroomBtn">Select Classrooms</button>
                <div class="selected-items" id="selectedClassrooms">
                    <small>No classrooms selected</small>
                </div>
            </div>

            <div class="form-group">
                <label>Mark Teacher Unavailability</label>
                <button type="button" class="popup-btn" id="unavailabilityBtn">Manage Teacher Availability</button>
                <div class="selected-items" id="unavailableTeachers">
                    <small>No teachers marked unavailable</small>
                </div>
            </div>

            <button type="submit" class="submit-btn">Create Exam</button>
        </form>
    </div>

    <!-- Classroom Selection Modal -->
    <div id="classroomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Classrooms</h3>
                <span class="close" id="closeClassroom">&times;</span>
            </div>
            <div class="modal-body">
                <div class="block-selector" id="blockSelector">
                    <!-- Building buttons will be populated here -->
                </div>
                <div class="classroom-grid" id="classroomGrid">
                    <!-- Classrooms will be populated here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancelClassroom">Cancel</button>
                <button class="btn-primary" id="confirmClassroom">Confirm Selection</button>
            </div>
        </div>
    </div>

    <!-- Teacher Unavailability Modal -->
    <div id="unavailabilityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Teacher Availability</h3>
                <span class="close" id="closeUnavailability">&times;</span>
            </div>
            <div class="modal-body">
                <div class="teacher-search">
                    <input type="text" id="teacherSearch" placeholder="Enter teacher name">
                    <button class="add-teacher-btn" id="addTeacher">Add Teacher</button>
                </div>
                <div class="teacher-list" id="teacherList">
                    <!-- Teachers will be populated here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="cancelUnavailability">Cancel</button>
                <button class="btn-primary" id="confirmUnavailability">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const home = document.getElementById('home');
        home.addEventListener('click', () => {
            window.location.href = '/coeHome.html';
        });

        const classrooms = {};
        let selectedClassrooms = [];
        let tempSelectedClassrooms = [];
        let teacherList = [];
        let unavailableTeachers = [];
        let currentBlock = '';

        // Modal elements
        const classroomModal = document.getElementById('classroomModal');
        const unavailabilityModal = document.getElementById('unavailabilityModal');

        // Fetch classrooms from database
        fetch("/coe/createExam")
            .then(response => response.json())
            .then(data => {
                console.log("Classrooms from server:", data);

                // Group classrooms by building
                data.forEach(item => {
                    const building = item.building;
                    const name = item.name;

                    if (!classrooms[building]) {
                        classrooms[building] = [];
                    }
                    classrooms[building].push(name);
                });

                console.log("Organized classrooms:", classrooms);
                
                // Create buttons AFTER data is fetched
                createButtons();
            })
            .catch(err => console.error("Error fetching classrooms:", err));

        function createButtons() {
            const blockSelector = document.getElementById('blockSelector');
            blockSelector.innerHTML = '';

            // Create select all button
            const allBtn = document.createElement('button');
            allBtn.id = 'selectAllBtn';
            allBtn.textContent = 'Select All';
            allBtn.style.marginLeft = 'auto';
            allBtn.style.background = '#28a745';
            allBtn.className = 'block-btn';
            allBtn.onclick = selectAllClassrooms;
            blockSelector.appendChild(allBtn);

            let index = 0;
            // Add button for each building
            Object.keys(classrooms).forEach((building) => {
                const btn = document.createElement('button');
                btn.className = 'block-btn';
                btn.dataset.block = building;
                btn.textContent = building;

                if (index === 0) {
                    btn.classList.add('active');
                    index++;
                }
                
                btn.onclick = () => {
                    document.querySelectorAll('.block-btn').forEach(b => {
                        if (b.id !== 'selectAllBtn') {
                            b.classList.remove('active');
                        }
                    });
                    btn.classList.add('active');
                    currentBlock = building;
                    loadClassrooms(building);
                };
                
                blockSelector.insertBefore(btn, allBtn);
            });

            // Set initial block and load classrooms
            if (Object.keys(classrooms).length > 0) {
                currentBlock = Object.keys(classrooms)[0];
                loadClassrooms(currentBlock);
            }
        }

        // Open classroom modal
        document.getElementById('classroomBtn').onclick = function() {
            tempSelectedClassrooms = [...selectedClassrooms];
            classroomModal.style.display = 'block';
            
            // Reload current block's classrooms if data is loaded
            if (currentBlock && classrooms[currentBlock]) {
                loadClassrooms(currentBlock);
            }
        };

        // Open unavailability modal
        document.getElementById('unavailabilityBtn').onclick = function() {
            unavailabilityModal.style.display = 'block';
            displayTeachers();
        };

        // Close modals
        document.getElementById('closeClassroom').onclick = function() {
            classroomModal.style.display = 'none';
        };

        document.getElementById('closeUnavailability').onclick = function() {
            unavailabilityModal.style.display = 'none';
        };

        document.getElementById('cancelClassroom').onclick = function() {
            classroomModal.style.display = 'none';
        };

        document.getElementById('cancelUnavailability').onclick = function() {
            unavailabilityModal.style.display = 'none';
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target === classroomModal) {
                classroomModal.style.display = 'none';
            }
            if (event.target === unavailabilityModal) {
                unavailabilityModal.style.display = 'none';
            }
        };

        // Select all classrooms in current block
        function selectAllClassrooms() {
            const currentClassrooms = classrooms[currentBlock] || [];
            currentClassrooms.forEach(room => {
                if (!tempSelectedClassrooms.includes(room)) {
                    tempSelectedClassrooms.push(room);
                }
            });
            loadClassrooms(currentBlock);
        }

        // Load classrooms for selected block
        function loadClassrooms(building) {
            const grid = document.getElementById('classroomGrid');
            grid.innerHTML = '';

            const rooms = classrooms[building] || [];
            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'classroom-item';
                if (tempSelectedClassrooms.includes(room)) {
                    div.classList.add('selected');
                }
                div.textContent = room;

                div.onclick = function() {
                    this.classList.toggle('selected');
                    if (tempSelectedClassrooms.includes(room)) {
                        tempSelectedClassrooms = tempSelectedClassrooms.filter(r => r !== room);
                    } else {
                        tempSelectedClassrooms.push(room);
                    }
                };

                grid.appendChild(div);
            });
        }

        // Confirm classroom selection
        document.getElementById('confirmClassroom').onclick = function() {
            selectedClassrooms = [...tempSelectedClassrooms];
            updateSelectedClassrooms();
            classroomModal.style.display = 'none';
        };

        // Update selected classrooms display
        function updateSelectedClassrooms() {
            const container = document.getElementById('selectedClassrooms');
            if (selectedClassrooms.length === 0) {
                container.innerHTML = '<small>No classrooms selected</small>';
            } else {
                container.innerHTML = selectedClassrooms.map(classroom => 
                    `<span class="selected-item">${classroom}<span class="remove-item" onclick="removeClassroom('${classroom}')">&times;</span></span>`
                ).join('');
            }
        }

        // Remove classroom
        function removeClassroom(classroom) {
            selectedClassrooms = selectedClassrooms.filter(c => c !== classroom);
            updateSelectedClassrooms();
        }

        // Add teacher
        document.getElementById('addTeacher').onclick = function() {
            const input = document.getElementById('teacherSearch');
            const teacherName = input.value.trim();
            if (teacherName && !teacherList.includes(teacherName)) {
                teacherList.push(teacherName);
                input.value = '';
                displayTeachers();
            }
        };

        // Display teachers
        function displayTeachers() {
            const container = document.getElementById('teacherList');
            container.innerHTML = '';
            
            teacherList.forEach(teacher => {
                const div = document.createElement('div');
                div.className = 'teacher-item';
                if (unavailableTeachers.includes(teacher)) {
                    div.classList.add('unavailable');
                }
                
                div.innerHTML = `
                    <span>${teacher}</span>
                    <button class="toggle-btn" onclick="toggleTeacherAvailability('${teacher}')">
                        ${unavailableTeachers.includes(teacher) ? 'Mark Available' : 'Mark Unavailable'}
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Toggle teacher availability
        function toggleTeacherAvailability(teacher) {
            if (unavailableTeachers.includes(teacher)) {
                unavailableTeachers = unavailableTeachers.filter(t => t !== teacher);
            } else {
                unavailableTeachers.push(teacher);
            }
            displayTeachers();
        }

        // Confirm unavailability changes
        document.getElementById('confirmUnavailability').onclick = function() {
            updateUnavailableTeachers();
            unavailabilityModal.style.display = 'none';
        };

        // Update unavailable teachers display
        function updateUnavailableTeachers() {
            const container = document.getElementById('unavailableTeachers');
            if (unavailableTeachers.length === 0) {
                container.innerHTML = '<small>No teachers marked unavailable</small>';
            } else {
                container.innerHTML = unavailableTeachers.map(teacher => 
                    `<span class="selected-item">${teacher}<span class="remove-item" onclick="removeUnavailableTeacher('${teacher}')">&times;</span></span>`
                ).join('');
            }
        }

        // Remove unavailable teacher
        function removeUnavailableTeacher(teacher) {
            unavailableTeachers = unavailableTeachers.filter(t => t !== teacher);
            updateUnavailableTeachers();
        }

        // Form submission
        document.getElementById('examForm').onsubmit = function(e) {
            e.preventDefault();
            
            const formData = {
                examName: document.getElementById('examName').value,
                duration: document.getElementById('duration').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                selectedClassrooms: selectedClassrooms,
                unavailableTeachers: unavailableTeachers
            };
            
            console.log('Exam Data:', formData);
            alert('Exam created successfully!');
        };

        // Initialize with some sample teachers
        teacherList = ['Dr. Smith', 'Prof. Johnson', 'Ms. Davis', 'Mr. Wilson', 'Dr. Brown'];
        displayTeachers();
    </script>
</body>
</html>